{% extends "base.html" %}

{% block title %}My Projects - Research Portal{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
        width: 100%;
        align-items: stretch;
    }

    .grid-card {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-radius: var(--space-4);
        padding: var(--space-6);
        box-shadow: var(--glass-shadow);
        transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        min-height: 180px;
    }

    .grid-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        border-color: rgba(99, 102, 241, 0.4);
    }

    .filing-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-4);
        width: 100%;
    }

    .archive-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: var(--space-2);
        border-radius: var(--space-1);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        position: relative;
    }

    .archive-btn:hover {
        color: var(--error);
        background: rgba(239, 68, 68, 0.1);
    }

    .filing-icon {
        background: rgba(99, 102, 241, 0.15);
        color: var(--primary);
        padding: var(--space-3);
        border-radius: var(--space-2);
    }

    .filing-icon svg {
        width: 24px;
        height: 24px;
    }

    .filing-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 var(--space-1) 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
    }

    .filing-company {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
    }

    .filing-meta {
        margin-top: auto;
        padding-top: var(--space-4);
        border-top: 1px solid var(--glass-border);
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted);
    }

    .search-container {
        position: relative;
        width: 100%;
        max-width: 400px;
    }

    .search-input {
        width: 100%;
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid var(--glass-border);
        border-radius: var(--space-2);
        padding: var(--space-3) var(--space-4) var(--space-3) 40px;
        color: var(--text-main);
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        background: rgba(15, 23, 42, 0.6);
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .dashboard-header {
            flex-direction: column;
            align-items: flex-start !important;
            gap: var(--space-4);
        }

        .search-container {
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header"
    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-8); width: 100%;">
    <h1 style="margin: 0; font-size: 2rem; font-weight: 700;">My Projects</h1>
    <div class="search-container">
        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" id="projectSearch" class="search-input" placeholder="Search projects by name or company..."
            onkeyup="filterProjects()">
    </div>
</div>

<div class="flashes-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
</div>

{% if projects %}
<div class="dashboard-grid">
    {% for project in projects %}
    <div class="grid-card" id="project-card-{{ project.id }}"
        onclick="window.location.href='{{ url_for('view_result', project_id=project.id) }}'">
        <div class="filing-header">
            <div class="filing-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
            </div>

            <div style="display: flex; gap: 8px;">
                <button type="button" class="archive-btn" onclick="archiveProject(event, {{ project.id }})"
                    aria-label="Archive Project">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4">
                        </path>
                    </svg>
                </button>

                <button type="button" class="archive-btn" aria-label="Delete Project"
                    onclick="deleteProject(event, {{ project.id }})"
                    style="color: #ef4444; border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.1);">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
        <h3 class="filing-title">{{ project.filename }}</h3>
        <p class="filing-company">{{ project.company_name }}</p>

        <div class="filing-meta">
            <span>{{ project.uploaded_at.strftime('%b %d, %Y') }}</span>
            <span
                style="color: {% if project.status == 'Completed' %}var(--success){% elif project.status == 'Failed' %}var(--error){% else %}var(--primary){% endif %};">
                {{ project.status }}
            </span>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="glass-card"
    style="text-align: center; padding: 60px 20px; max-width: 600px; margin: 0 auto; margin-top: 40px; border-style: dashed;">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="64" height="64"
        style="color: var(--text-muted); margin-bottom: var(--space-4);">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
    </svg>
    <h2 style="font-size: 1.5rem; margin-top: 0; margin-bottom: 8px;">No Projects Found</h2>
    <p style="color: var(--text-muted); line-height: 1.5;">You haven't processed any documents yet.</p>
    <a href="{{ url_for('dashboard') }}" class="btn-gradient" style="margin-top: 24px;">Upload Document</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    function filterProjects() {
        const input = document.getElementById('projectSearch');
        const filter = input.value.toLowerCase();
        const grid = document.querySelector('.dashboard-grid');

        if (!grid) return;

        const cards = grid.getElementsByClassName('grid-card');

        for (let i = 0; i < cards.length; i++) {
            const title = cards[i].querySelector('.filing-title').innerText.toLowerCase();
            const company = cards[i].querySelector('.filing-company').innerText.toLowerCase();

            if (title.indexOf(filter) > -1 || company.indexOf(filter) > -1) {
                cards[i].style.display = "";
            } else {
                cards[i].style.display = "none";
            }
        }
    }

    function archiveProject(event, projectId) {
        // Prevent navigating to the result page
        event.preventDefault();
        event.stopPropagation();

        fetch(`/api/archive/${projectId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ is_archived: true })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const card = document.getElementById(`project-card-${projectId}`);
                    if (card) {
                        card.style.opacity = '0';
                        setTimeout(() => {
                            card.remove();
                            // Optional: Check if empty and show empty state
                            const grid = document.querySelector('.dashboard-grid');
                            if (grid && grid.children.length === 0) {
                                window.location.reload();
                            }
                        }, 300);
                    }
                } else {
                    alert(data.error || "Failed to archive project.");
                }
            })
            .catch(err => {
                console.error("Archiving error:", err);
                alert("An unexpected error occurred.");
            });
    }

    function deleteProject(event, projectId) {
        event.preventDefault();
        event.stopPropagation();

        if (confirm('Are you sure you want to completely delete this dataset? This cannot be undone.')) {
            fetch(`/api/delete/${projectId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const card = document.getElementById(`project-card-${projectId}`);
                        if (card) {
                            card.style.opacity = '0';
                            setTimeout(() => {
                                card.remove();
                                const grid = document.querySelector('.dashboard-grid');
                                if (grid && grid.children.length === 0) {
                                    window.location.reload();
                                }
                            }, 300);
                        }
                    } else {
                        alert(data.error || "Failed to delete project.");
                    }
                })
                .catch(err => {
                    console.error("Deleting error:", err);
                    alert("An unexpected error occurred.");
                });
        }
    }
</script>
{% endblock %}